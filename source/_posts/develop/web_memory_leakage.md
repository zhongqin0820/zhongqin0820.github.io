---
title: web开发之内存泄漏
date: 2017-11-12 22:31:10
categories:
- 网页开发

tags:
- Node.js
---
# 前言
以下文章内容大都摘自[阮一峰的网络博客JavaScript 内存泄漏教程篇](http://www.ruanyifeng.com/blog/2017/04/memory-leak.html),仅作个人学习笔记备记。
本来不想记的，因为对于只是在本地写`hello world`的我来说，内存管理似乎从来不是一件必要的事情。
但是，突然想到，内存的管理对于部署在服务器上的或者说生产环境中的应用是多么的重要。
想象一下，要是一个需要7/24运行的web应用内存泄漏了：）简直就是一场灾难。服务器怠机则无法提供服务。

<!-- more -->
# 什么是内存泄漏
对于持续运行的服务进程（daemon），必须及时释放不再用到的内存。否则，内存占用越来越高，轻则影响系统性能，重则导致进程崩溃。
不再用到的内存，没有及时释放，就叫做内存泄漏（memory leak）。
有些语言（比如 C 语言）必须手动释放内存，程序员负责内存管理。这很麻烦，所以大多数语言提供自动内存管理，减轻程序员的负担，这被称为"垃圾回收机制"（garbage collector）。

# 垃圾回收机制
最常使用的方法叫做"引用计数"（`reference counting`）：语言引擎有一张"引用表"，保存了内存里面所有的资源（通常是各种值）的引用次数。如果一个值的引用次数是0，就表示这个值不再用到了，因此可以将这块内存释放。
但是，并不是说有了垃圾回收机制，程序员就轻松了。你还是需要关注内存占用：那些很占空间的值，一旦不再用到，你必须检查是否还存在对它们的引用。如果是的话，就必须手动解除引用。

# 内存泄漏的识别方法
经验法则是，如果连续`五次垃圾回收`之后，内存占用一次比一次大，就有内存泄漏。这就要求`实时查看内存占用`。
## 浏览器
Chrome 浏览器查看内存占用，按照以下步骤操作。
```
1. 打开开发者工具，选择 Timeline 面板
2. 在顶部的Capture字段里面勾选 Memory
3. 点击左上角的录制按钮。
4. 在页面上进行各种操作，模拟用户的使用情况。
5. 一段时间后，点击对话框的 stop 按钮，面板上就会显示这段时间的内存占用情况。
```
如果内存占用基本平稳，接近水平，就说明不存在内存泄漏。
反之，就是内存泄漏了。

## 命令行
命令行可以使用` Node` 提供的`process.memoryUsage`方法。
`process.memoryUsage`返回一个`对象`，包含了 `Node `进程的内存占用信息。该对象包含`四个字段`，单位是`字节`。判断内存泄漏，以`heapUsed字段`为准。
```
rss（resident set size）：所有内存占用，包括指令区和堆栈。
heapTotal："堆"占用的内存，包括用到的和没用到的。
heapUsed：用到的堆的部分。
external： V8 引擎内部的 C++ 对象占用的内存。
```
# WeakMap
ES6 考虑到了这一点，推出了两种新的数据结构：`WeakSet` 和 `WeakMap`。它们对于值的引用都是不计入垃圾回收机制的，所以名字里面才会有一个"Weak"，表示这是弱引用。

# 参考链接
[JavaScript 内存泄漏教程](http://www.ruanyifeng.com/blog/2017/04/memory-leak.html)