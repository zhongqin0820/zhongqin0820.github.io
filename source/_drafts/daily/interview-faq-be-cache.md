---
title: 知识梳理：缓存相关
date: 2019-09-11 17:04:42
updated: 2019-09-23 13:42:31
categories:
- 计算机基础

tags:
- 学习总结
---
# 前言
梳理总结缓存相关的基础概念。

<!-- more -->
# 广义上的缓存
## 缓存定义
- 只要能用来放置临时数据**提升程序性能**的都可以称之为缓存

### 缓存容量
由于资源的局限性，缓存具有容量上限。当缓存达到上限时，需要使用**数据淘汰策略**淘汰部分当前不需要的数据，让出空间给将要使用的数据从而最大化提高程序性能。

#### 命中率与缺页率
缓存命中率与缺页率是衡量数据淘汰策略的**两个重要指标**。但这两个指标还可能受[其它因素](https://baike.baidu.com/item/%E7%BC%BA%E9%A1%B5%E7%8E%87/19760875)影响，如：缓存自身的页面大小，分配给调度缓存进程的空间大小以及程序自身是否最大化利用程序局部性原理的影响。
$$ 总请求数 = 命中数 + 缺页数 $$
$$ 命中率 = \frac{命中数}{总请求数} $$
$$ 缺页率 = \frac{缺页数}{总请求数} $$
$$ 1 = 命中率 + 缺页率 $$

命中与缺页是对立的，因此可以在命中率与缺页率中择一衡量数据淘汰策略。

#### 最佳置换算法（OPT）
最佳置换算法是一种理想的数据淘汰策略，当缓存满时，它需要通过**预见**后续所有的数据请求，淘汰当前缓存中的最远不使用的数据。
然而，在现实场景中由于无法预知后续到来数据的顺序，因此在实际中并不使用，其通常作为基准来评价其他策略的优劣。

### 常见数据淘汰策略
- **LRU（Least Recently Used）**：最近最久未使用策略，优先淘汰最久未使用的数据，也就是上次被访问时间距离现在最久的数据。该策略可以保证内存中的数据都是热点数据，也就是经常被访问的数据，从而保证缓存命中率。**面试常问**。
- FIFO（First In First Out）：先进先出策略，在实时性的场景下，需要经常访问最新的数据，那么就可以使用 FIFO，使得最先进入的数据（最早的数据）被淘汰。
- LFU（Least Frequently Used）：最不经常使用策略，优先淘汰一段时间内使用次数最少的数据。

> 注：在操作系统内存管理中，其数据淘汰策略也被叫作**内存页面置换算法**。

#### LRU算法实现
- [LeetCode - 146. LRU Cache](https://leetcode.com/problems/lru-cache/description/)
- 数据结构：双向链表 + HashMap
- **保持最新**：
    - 访问某个节点时，将其从原来的位置删除，并重新插入到链表头部。这样就能保证**链表尾部存储的就是最近最久未使用的节点**，当节点数量大于缓存最大空间时就淘汰链表尾部的节点。
- **保证命中/删除时间复杂度O(1)**：
    - 为了使删除操作时间复杂度为 O(1)，就不能采用遍历的方式找到某个节点。HashMap 存储着 Key 到节点的映射，通过 Key 就能以 O(1) 的时间得到节点，然后再以 O(1) 的时间将其从双向队列中删除。
    - 注意：删除的条件是**当前缓存的大小超过预设的容量**。 

### 区分Buffer与Cache（缓冲与缓存）
- Buffer是提高写入效率
- Cache是提高读取效率

## 缓存介质
1. 从网络获取内容较慢，我们可以用数据库进行缓存
2. 数据库(非本机)较慢，我们可以用本地文件进行缓存
3. 本地文件较慢，我们可以用内存进行缓存
4. 内存较慢，我们可以用L2进行缓存
5. L2也慢，我们可以用寄存器进行缓存

## 缓存分类
根据缓存与应用的耦合度进行分类

### 本地内存缓存（编程直接实现）
- 成员变量或局部变量实现
- 静态变量实现

### 客户端缓存（[浏览器](#网络缓存)）
- 浏览器：cookie
- [HTML5提供的本地存储](https://www.w3school.com.cn/html/html5_webstorage.asp)：localStorage，sessionStorage
- 浏览器本地缓存
- FLASH本地存储

### 分布式数据库缓存
通常这些数据库产品将高频数据放到了数据访问速度更快的地方，如：内存以及系统缓存上。
- Memcached缓存
- Redis缓存

## 使用场景需要考虑的问题
通常情况下，使用缓存的目的是为了**满足系统"高性能"和"高并发"的需求**。而系统的瓶颈通常在数据I/O部分的开销，如果**不使用缓存**，每次查询数据都要从数据库查将严重消耗数据库性能。"分布式数据库缓存"的出现大大减轻了查询时对数据库的依赖，降低了直接I/O的时间开销，将部分高频数据放到访问速度更快的地方从而降低整体的时间开销。
- [如何正确使用缓存技术 - 陈大侠的文章 - 知乎](https://zhuanlan.zhihu.com/p/25991920)：仅在必要时使用缓存
- [缓存穿透，缓存击穿，缓存雪崩解决方案分析 - 孤独键客的文章 - 知乎](https://zhuanlan.zhihu.com/p/58224918)：使用缓存常见的问题

# 狭义上的缓存
## 操作系统缓存（计算机基础）
- [CS-Notes/notes/计算机操作系统 - 内存管理.md](https://github.com/CyC2018/CS-Notes/blob/master/notes/%E8%AE%A1%E7%AE%97%E6%9C%BA%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%20-%20%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86.md)
- [CS-Notes/notes/缓存.md - CPU 多级缓存](https://github.com/CyC2018/CS-Notes/blob/master/notes/%E7%BC%93%E5%AD%98.md#cpu-%E5%A4%9A%E7%BA%A7%E7%BC%93%E5%AD%98)

## 网络缓存（前端面试常考）
### DNS缓存（查询过程）
- 首先搜索浏览器自身的DNS缓存，如果存在，则域名解析到此完成。
- 如果浏览器自身的缓存里面没有找到对应的条目，那么会尝试读取操作系统的hosts文件看是否存在对应的映射关系，如果存在，则域名解析到此完成。
- 如果本地hosts文件不存在映射关系，则查找本地DNS服务器(ISP服务器，或者自己手动设置的DNS服务器)，如果存在，域名到此解析完成。
- 如果本地DNS服务器还没找到的话，它就会向根服务器发出请求，进行递归查询。

### CDN缓存
CDN服务商一般会提供基于文件后缀、目录多个维度来指定CDN缓存时间，为用户提供更精细化的缓存管理。CDN边缘节点缓存策略因服务商不同而不同，但一般都会遵循HTTP标准协议，通过HTTP响应头中的`Cache-control: max-age`的字段来设置CDN边缘节点数据缓存时间。

#### ISP
网络服务提供商（ISP）是网络访问的第一跳，通过将数据缓存在 ISP 中能够大大提高用户的访问速度。

#### 机制
当浏览器向CDN节点请求数据时，CDN节点会判断缓存数据是否过期，
未过期：直接将缓存数据返回给客户端；
过期：CDN节点向服务器发出回源请求，**拉取最新数据同时更新本地缓存**，并将最新数据返回给客户端。

#### 优势
- CDN节点解决了跨运营商和跨地域访问的问题，访问延时大大降低。
- 大部分请求在CDN边缘节点完成，CDN起到了分流作用，减轻了源服务器的负载。

### HTTP缓存机制
<div style="width: 300px; margin: auto">

![HTTP缓存示意图](https://raw.githubusercontent.com/zhongqin0820/zhongqin0820.github.io/source-articles/source/images/daily/interview/cache-http.png)
</div>

#### 浏览器缓存的分类
- **强缓存**：利用http的返回头中的`Expires`或者`Cache-Control`两个字段来控制的，用来表示资源的缓存时间。
- **协商缓存**：根据请求头中的`Last-Modify/If-Modify-Since `和 `ETag/If-None-Match`来判断是否命中，如果命中，则返回304 ，告诉浏览器资源未更新，可使用本地的缓存。

## 数据库缓存（后端面试常考）
- [数据库缓存的几种方式](https://www.cnblogs.com/hadley/p/9557596.html)：数据库产品实现过程中所设计的缓存机制
- [高并发和大流量解决方案--数据库缓存](https://www.cnblogs.com/xiaoliwang/p/9327073.html)：数据库自带的缓存机制
- [一个经典面试题：如何保证缓存与数据库的双写一致性？](https://zhuanlan.zhihu.com/p/66462064)

# 学习资料
- [CS-Notes/notes/缓存.md](https://github.com/CyC2018/CS-Notes/blob/master/notes/%E7%BC%93%E5%AD%98.md)
- [缓存那些事 - 美团技术团队的文章 - 知乎](https://zhuanlan.zhihu.com/p/27457401)
- [什么叫缓存？ - 蓝冰的回答 - 知乎](https://www.zhihu.com/question/294362421/answer/493864362)
- [大型web系统数据缓存设计](https://www.cnblogs.com/siqi/p/5096317.html)：数据库缓存相关
- [都9012了，听说你还不了解缓存？ - 团队小编的文章 - 知乎](https://zhuanlan.zhihu.com/p/73345909)：网络缓存相关，推荐阅读
- [HTTP：缓存机制](https://blog.daixinye.com/2017/10/09/HTTP%E7%BC%93%E5%AD%98%E6%9C%BA%E5%88%B6/)
- [浏览器缓存原理以及本地存储](https://segmentfault.com/a/1190000017185195?utm_source=tag-newest)：整理的较为完善，推荐阅读

## 缓存相关面试问题集锦
- [缓存相关面试问题总结 - （一）、（二）](https://blog.csdn.net/box_clf/article/category/8431461)
- [一个经典面试题：如何保证缓存与数据库的双写一致性？](https://zhuanlan.zhihu.com/p/66462064)：这个问题值得思考
- [高并发和大流量解决方案--数据库缓存](https://www.cnblogs.com/xiaoliwang/p/9327073.html)
- [数据库缓存的几种方式](https://www.cnblogs.com/hadley/p/9557596.html)

# Changelog
- 2019/09/11：第一版内容
- 2019/09/23：完善[广义上的缓存](#广义上的缓存)部分内容
